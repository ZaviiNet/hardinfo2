name: Build AppImage

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git cmake build-essential gettext curl wget \
          libjson-glib-dev zlib1g-dev libsoup-3.0-dev \
          libgtk-3-dev libglib2.0-dev libqt5opengl5-dev \
          qtbase5-dev libdecor-0-dev libxkbcommon-x11-dev \
          glslang-tools

    - name: Build and Install to AppDir
      run: |
        mkdir build && cd build
        # Configure with /usr prefix as required by AppImage standards
        cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
        # Install into a local 'AppDir' folder instead of the system
        make install DESTDIR=AppDir

    - name: Package as AppImage
      run: |
        # Download linuxdeploy and the GTK plugin
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
        chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh

        # Export variables for linuxdeploy
        export OUTPUT=hardinfo2-x86_64.AppImage
        
        # Run linuxdeploy to bundle dependencies and create the AppImage
        # It uses the desktop file and icon generated during the 'make install' step
        ./linuxdeploy-x86_64.AppImage --appdir build/AppDir \
          --plugin gtk \
          --output appimage \
          --desktop-file build/AppDir/usr/share/applications/hardinfo2.desktop \
          --icon-file build/AppDir/usr/share/icons/hicolor/scalable/apps/hardinfo2.svg

    - name: Upload AppImage Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hardinfo2-x86_64
        path: ./*.AppImage
